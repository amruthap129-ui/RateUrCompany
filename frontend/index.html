<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Rate Your Organization - Login</title>
  <style>
    body{font-family:Arial;background:#f3f6fa;display:flex;align-items:center;justify-content:center;height:100vh}
    .card{width:380px;background:#fff;padding:24px;border-radius:8px;box-shadow:0 4px 18px rgba(0,0,0,.08)}
    h2{text-align:center;color:#0056b3}
    h3{text-align:center;color:#125eaf}
    input{width:90%;padding:10px;margin:8px 0;border-radius:6px;border:1px solid #ccc}
    button{width:90%;padding:10px;border:none;background:#007bff;color:#fff;border-radius:6px;cursor:pointer}
    .muted{text-align:center;margin-top:8px}
  </style>
</head>
<body>
  <div class="card">
    <h2 id="title">Rate Your Organization</h2>

    <form id="loginForm">
      <h3 id="title">Login</h3>
      <input id="loginEmail" type="email" placeholder="Email" required />
      <input id="loginPassword" type="password" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>

    <form id="registerForm" style="display:none">
      <h3 id="title">Create Account</h3>
      <input id="regName" placeholder="Full name" required />
      <input id="regEmail" type="email" placeholder="Email" required />
      <input id="regPassword" type="password" placeholder="Password" required />
      <input id="regDept" placeholder="Department (optional)" />
      <button id="createBtn" type="button">Create Account</button>
    </form>

      <div class="muted">
      <span id="toggleText">
        Don’t have an account? <a href="#" id="toggleLink">Sign up</a>
      </span>
      <span id="regToggleText" style="display:none">
        Already have an account? <a href="#" id="loginLink">Login</a>
      </span>
    </div>

  </div>

  <script>
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const formTitle = document.getElementById('formTitle');
    const toggleText = document.getElementById('toggleText');
    const regToggleText = document.getElementById('regToggleText');
    const toggleLink = document.getElementById('toggleLink');
    const loginLink = document.getElementById('loginLink');

    toggleLink.addEventListener('click', (e) => {
      e.preventDefault();
      clearFormFields();
      loginForm.style.display = 'none';
      registerForm.style.display = 'block';
      toggleText.style.display = 'none';
      regToggleText.style.display = 'inline';
      formTitle.textContent = 'Create account';
    });

    loginLink.addEventListener('click', (e) => {
      e.preventDefault();
      clearFormFields();
      loginForm.style.display = 'block';
      registerForm.style.display = 'none';
      toggleText.style.display = 'inline';
      regToggleText.style.display = 'none';
      formTitle.textContent = 'Login';
    });

    function clearFormFields() {
  document.querySelectorAll('input').forEach(input => input.value = '');
   }

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value.trim();

      try {
        const res = await fetch('http://localhost:3000/api/auth/login', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (!res.ok) return alert(data.message || 'Login failed');
        // store user object
        localStorage.setItem('user', JSON.stringify(data.user));
        localStorage.setItem('employee_id', data.user.id);
        localStorage.setItem('employee_name', data.user.name);
        localStorage.setItem('role', data.user.role || 'employee');

        // check if user already rated (optional: can be handled on rating submit)
        const chk = await fetch(`http://localhost:3000/api/rating/check/${data.user.id}`);
        const chkJson = await chk.json();
        if (chkJson.exists) localStorage.setItem(`hasRated_${data.user.id}`, 'true');
        else localStorage.removeItem(`hasRated_${data.user.id}`);

        window.location.href = 'dashboard.html';
      } catch (err) {
        console.error(err);
        alert('Server error');
      }
    });

    document.getElementById('createBtn').addEventListener('click', async () => {
      const name = document.getElementById('regName').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const password = document.getElementById('regPassword').value.trim();
      const department = document.getElementById('regDept').value.trim();

      if (!name || !email || !password) return alert('Please fill required fields');
      const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailPattern.test(email)) {
  return alert('Please enter a valid email address (e.g., name@example.com)');
}

      try {
        const res = await fetch('http://localhost:3000/api/auth/register', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, password, department, role: 'employee' })
        });
        const data = await res.json();
        if (!res.ok) return alert(data.message || 'Register failed');
        // autologin the newly created user
        localStorage.setItem('user', JSON.stringify(data.user));
        localStorage.setItem('employee_id', data.user.id);
        localStorage.setItem('employee_name', data.user.name);
        localStorage.setItem('role', data.user.role || 'employee');
        alert('✅ Account created. Redirecting to Login...');
        window.location.href = 'dashboard.html';
      } catch (err) {
        console.error(err);
        alert('Server error');
      }
    });
  </script>
</body>
</html>
