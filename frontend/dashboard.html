<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dashboard</title>
  <style>
    body {
      font-family: Arial;
      background: #eef2f7;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 40px;
    }
    h1 { color: #0056b3; }
    h3 { text-align: center; color: #125eaf; }
    #ratingTable { border-collapse: collapse; width: 90%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
    th { background: #007bff; color: #fff; }
    #controls { margin: 20px; }
    button {
      padding: 10px 14px;
      margin-right: 8px;
      border-radius: 6px;
      border: none;
      background: #007bff;
      color: #fff;
      cursor: pointer;
    }
    button:hover { background: #0056b3; }
    .pay-btn {
        background: #28a745;
    color: white;
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    }
    .pay-btn:disabled { background: #ccc; cursor: not-allowed; }
    .no-pay { color: #777; font-style: italic; }
    .statusCell {
    text-align: center;
    font-size: 14px;
  }
    .employee-company {
      background: #fff;
      padding: 20px;
      margin-top: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 8px;
      width: 60%;
    }
  </style>
</head>

<body>
  <h1>Welcome to Rate Your Organization Portal</h1>

  <!-- Employee Section -->
  <div id="employeeSection">
    <p>Would you like to rate your organization?</p>
    <div id="controls">
      <button id="rateButton">Yes, Rate Now</button>
      <button id="logoutBtn">Logout</button>
    </div>
  </div>

  <!-- Employee Rating Summary -->
  <div id="employeeCompanyRating" class="employee-company" style="display:none">
    <h3>Your Company Rating Summary</h3>
    <p id="companyInfo"></p>
    <div id="paymentSection"></div>
  </div>

  <!-- Admin Section -->
  <div id="adminSection" style="display:none">
    <h3>Company-wise Ratings</h3>
    <table id="ratingTable">
      <thead>
        <tr>
          <th>Employee Name</th>
          <th>Company</th>
          <th>Avg Rating</th>
          <th>Salary</th>
          <th>Growth</th>
          <th>Benefits</th>
          <th>Balance</th>
          <th>Payment</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div style="margin-top:16px">
      <button id="logoutAdmin">Logout</button>
    </div>
  </div>

  <script>
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    if (!user) { alert('Please login'); location.href = 'index.html'; }

    const employeeId = user.id;
    const role = user.role || localStorage.getItem('role') || 'employee';
    const hasRated = localStorage.getItem(`hasRated_${employeeId}`) === 'true';
    const hasPaid = localStorage.getItem(`hasPaid_${employeeId}`) === 'true';

    const rateButton = document.getElementById('rateButton');

    if (role === 'admin') {
      document.getElementById('employeeSection').style.display = 'none';
      document.getElementById('adminSection').style.display = 'block';
      loadAdminData();
    } else {
      document.getElementById('employeeSection').style.display = 'block';
      document.getElementById('adminSection').style.display = 'none';
      if (hasRated) {
        rateButton.textContent = 'âœ… Already Rated';
        rateButton.disabled = true;
        rateButton.style.background = '#ccc';
        showUserCompanyRating();
      }
    }

    rateButton.addEventListener('click', () => {
      if (hasRated) return alert('âœ… You already rated.');
      window.location.href = 'rating.html';
    });

    function logoutAll() {
      localStorage.removeItem('user');
      localStorage.removeItem('role');
      alert('Logged out successfully.');
      location.href = 'index.html';
    }

    document.getElementById('logoutBtn').addEventListener('click', logoutAll);
    document.getElementById('logoutAdmin').addEventListener('click', logoutAll);

    async function showUserCompanyRating() {
      try {
        const res = await fetch('http://localhost:3000/api/admin/ratings');
        const data = await res.json();
        const company = data.find(d => d.employee_name.toLowerCase() === user.name.toLowerCase());

        if (!company) {
          document.getElementById('employeeCompanyRating').style.display = 'block';
          document.getElementById('companyInfo').innerHTML = 'No company rating found yet.';
          return;
        }

        const avg = parseFloat(company.avg_rating || 0).toFixed(2);
        const section = document.getElementById('employeeCompanyRating');
        const info = document.getElementById('companyInfo');
        const paymentDiv = document.getElementById('paymentSection');

        section.style.display = 'block';
        info.innerHTML = `
          <strong>Company:</strong> ${company.company_name}<br>
          <strong>Average Rating:</strong> ${avg}
        `;

        if (hasPaid) {
          paymentDiv.innerHTML = `<span style="color:green;font-weight:bold;">âœ… Payment already done</span>`;
          return;
        }

        if (avg >= 4) {
          paymentDiv.innerHTML = `<button class="pay-btn" onclick="triggerPayment('${company.company_name}', 100, this)">ðŸ’° Pay</button>`;
        } else {
          paymentDiv.innerHTML = `<span class="no-pay">No payment needed</span>`;
        }
      } catch (err) {
        console.error(err);
        alert('Unable to load company rating.');
      }
    }

    async function triggerPayment(company_name, amount, button) {
      const confirmPay = confirm(`ðŸ“Š ${company_name} has an average rating above 4.0.\nProceed with payment of â‚¹${amount}?`);
      if (!confirmPay) return;

      button.disabled = true;
      button.textContent = 'Processing...';
      try {
        const res = await fetch('http://localhost:3000/api/payment/process', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ company_name, amount, payment_method: 'stripe' })
        });

        const data = await res.json();
        if (res.ok) {
          alert(`âœ… Payment successful!\nTransaction ID: ${data.transaction_id}`);
          button.textContent = 'âœ… Paid Successfully';
          button.style.background = '#28a745';
          localStorage.setItem(`hasPaid_${employeeId}`, 'true');
        } else {
          alert(`âŒ Payment failed: ${data.message}`);
          button.disabled = false;
          button.textContent = 'ðŸ’° Pay';
        }
      } catch (err) {
        alert('âš ï¸ Payment service unavailable.');
        button.disabled = false;
        button.textContent = 'ðŸ’° Pay';
      }
    }

    async function loadAdminData() {
      const res = await fetch('http://localhost:3000/api/admin/ratings');
      const data = await res.json();
      const tbody = document.querySelector('#ratingTable tbody');
      tbody.innerHTML = '';

      data.forEach(r => {
        const avg = parseFloat(r.avg_rating || 0);
        const paymentCell =
          avg >= 4 && hasPaid
            ? `<button class="pay-btn" onclick="triggerPayment('${r.company_name}', 100, this)">ðŸ’° Pay</button>`
            : `<span class="no-pay">No payment needed/already paid</span>`;
        tbody.innerHTML += `
          <tr>
            <td>${r.employee_name}</td>
            <td>${r.company_name}</td>
            <td>${avg.toFixed(2)}</td>
            <td>${r.salary}</td>
            <td>${r.growth}</td>
            <td>${r.benefits}</td>
            <td>${r.balance}</td>
            <td>${paymentCell}</td>
          </tr>`;
      });
    }
  </script>
</body>
</html>
